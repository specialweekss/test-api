# 项目打包和部署指南

## 一、本地打包

### 1. 使用 Maven 打包

在项目根目录执行以下命令：

```bash
mvn clean package
```

或者跳过测试打包（如果测试未通过）：

```bash
mvn clean package -DskipTests
```

### 2. 打包结果

打包完成后，会在 `target` 目录下生成可执行 JAR 文件：
- **文件位置**: `target/test-api-0.0.1-SNAPSHOT.jar`
- **文件大小**: 约 20-30MB（包含所有依赖）

### 3. 验证打包

可以本地测试运行：

```bash
java -jar target/test-api-0.0.1-SNAPSHOT.jar
```

---

## 二、云服务器部署

### 1. 服务器环境要求

- **操作系统**: Linux (CentOS/Ubuntu)
- **Java 版本**: JDK 1.8 或以上
- **MySQL**: 5.7 或 8.0
- **内存**: 至少 512MB（推荐 1GB+）
- **磁盘**: 至少 500MB 可用空间

### 2. 上传文件到服务器

#### 方式一：使用 SCP 命令

```bash
scp target/test-api-0.0.1-SNAPSHOT.jar root@specialweek.online:/root/test-api/
```

#### 方式二：使用 FTP/SFTP 工具

使用 FileZilla、WinSCP 等工具上传 JAR 文件到服务器。

#### 方式三：使用 Git

如果服务器已配置 Git，可以直接在服务器上克隆项目并打包。

### 3. 服务器环境准备

#### 3.1 安装 JDK 1.8

**CentOS/RHEL:**
```bash
yum install java-1.8.0-openjdk java-1.8.0-openjdk-devel
```

**Ubuntu/Debian:**
```bash
apt-get update
apt-get install openjdk-8-jdk
```

**验证安装:**
```bash
java -version
```

#### 3.2 安装 MySQL

**CentOS/RHEL:**
```bash
yum install mysql-server
systemctl start mysqld
systemctl enable mysqld
```

**Ubuntu/Debian:**
```bash
apt-get install mysql-server
systemctl start mysql
systemctl enable mysql
```

#### 3.3 创建数据库和用户

```sql
-- 登录 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE test DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选，建议使用独立用户）
CREATE USER 'testuser'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON test.* TO 'testuser'@'localhost';
FLUSH PRIVILEGES;

-- 执行初始化脚本
USE test;
SOURCE /path/to/init.sql;
```

#### 3.4 执行数据库初始化脚本

将 `src/main/resources/sql/init.sql` 上传到服务器并执行：

```bash
mysql -u root -p test < /path/to/init.sql
```

### 4. 创建应用目录

```bash
# 创建应用目录
mkdir -p /root/test-api
mkdir -p /root/test-api/logs
mkdir -p /root/test-api/config
mkdir -p /root/test-api/resources/assist  # 视频资源目录

# 设置权限
chmod 755 /root/test-api
chmod -R 755 /root/test-api/resources  # 确保资源目录可读
```

**注意**：如果使用 `/opt/test-api` 作为应用目录，请相应调整路径：
```bash
mkdir -p /opt/test-api
mkdir -p /opt/test-api/logs
mkdir -p /opt/test-api/config
mkdir -p /opt/test-api/resources/assist
chmod 755 /opt/test-api
chmod -R 755 /opt/test-api/resources
```

### 5. 配置准备

#### 5.1 设置微信环境变量（必须）

**重要**：微信 AppID 和 AppSecret 必须通过环境变量设置，不能写在配置文件中。

**方式1：在启动脚本中设置（推荐）**

在启动脚本中设置环境变量（见 6.1 节）。

**方式2：在系统环境变量中设置**

编辑 `~/.bashrc` 或 `~/.bash_profile`：
```bash
export WECHAT_APPID=wx1234567890abcdef
export WECHAT_SECRET=abcdef1234567890abcdef1234567890ab
```

然后执行：
```bash
source ~/.bashrc
```

**方式3：使用 systemd 服务（推荐用于生产环境）**

在 systemd 服务文件中设置环境变量（见 6.3 节）。

#### 5.2 创建生产环境配置文件（可选）

如果需要覆盖默认配置，可以在服务器上创建 `/opt/test-api/config/application-prod.properties`：

```properties
spring.application.name=test-api

# 数据库配置（根据实际情况修改）
spring.datasource.url=jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
spring.datasource.username=root
spring.datasource.password=your_actual_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# MyBatis 配置
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=org.lyf.testapi.entity
mybatis.configuration.map-underscore-to-camel-case=true

# Jackson 配置
spring.jackson.date-format=yyyy-MM-dd HH:mm:ss
spring.jackson.time-zone=Asia/Shanghai

# 服务器端口配置
server.port=8080

# 日志配置
logging.level.root=INFO
logging.level.org.lyf.testapi=DEBUG
logging.file.name=/opt/test-api/logs/test-api.log
logging.file.max-size=10MB
logging.file.max-history=30

# 静态资源路径配置（视频文件等）
# 生产环境建议使用绝对路径，确保资源文件可访问
app.resources.path=/opt/test-api/resources/

# 注意：微信配置通过环境变量设置，不在此文件中配置
```

### 6. 启动脚本

#### 6.1 创建启动脚本

创建 `/opt/test-api/start.sh`：

```bash
#!/bin/bash

APP_NAME="test-api"
APP_JAR="/opt/test-api/test-api-0.0.1-SNAPSHOT.jar"
APP_PID="/opt/test-api/test-api.pid"
APP_LOG="/opt/test-api/logs/test-api.log"
JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC"

# 检查是否已经运行
if [ -f "$APP_PID" ]; then
    PID=$(cat $APP_PID)
    if ps -p $PID > /dev/null 2>&1; then
        echo "$APP_NAME is already running with PID $PID"
        exit 1
    else
        rm -f $APP_PID
    fi
fi

# 设置微信环境变量（必须）
export WECHAT_APPID=wx1234567890abcdef  # 替换为实际的AppID
export WECHAT_SECRET=abcdef1234567890abcdef1234567890ab  # 替换为实际的AppSecret

# 启动应用
echo "Starting $APP_NAME..."
nohup java $JAVA_OPTS \
    -jar $APP_JAR \
    --spring.config.location=classpath:/application.properties,file:/opt/test-api/config/application-prod.properties \
    --spring.profiles.active=prod \
    > $APP_LOG 2>&1 &

echo $! > $APP_PID
echo "$APP_NAME started with PID $(cat $APP_PID)"
```

#### 6.2 创建停止脚本

创建 `/opt/test-api/stop.sh`：

```bash
#!/bin/bash

APP_NAME="test-api"
APP_PID="/opt/test-api/test-api.pid"

if [ ! -f "$APP_PID" ]; then
    echo "$APP_NAME is not running"
    exit 1
fi

PID=$(cat $APP_PID)
if ps -p $PID > /dev/null 2>&1; then
    echo "Stopping $APP_NAME (PID: $PID)..."
    kill $PID
    
    # 等待进程结束
    for i in {1..30}; do
        if ! ps -p $PID > /dev/null 2>&1; then
            break
        fi
        sleep 1
    done
    
    # 如果还在运行，强制杀死
    if ps -p $PID > /dev/null 2>&1; then
        echo "Force killing $APP_NAME..."
        kill -9 $PID
    fi
    
    rm -f $APP_PID
    echo "$APP_NAME stopped"
else
    echo "$APP_NAME is not running"
    rm -f $APP_PID
fi
```

#### 6.3 创建重启脚本

创建 `/opt/test-api/restart.sh`：

```bash
#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
$SCRIPT_DIR/stop.sh
sleep 2
$SCRIPT_DIR/start.sh
```

#### 6.4 设置脚本权限

```bash
chmod +x /opt/test-api/start.sh
chmod +x /opt/test-api/stop.sh
chmod +x /opt/test-api/restart.sh
```

### 7. 使用 Systemd 管理（推荐）

#### 7.1 创建服务文件

创建 `/etc/systemd/system/test-api.service`：

```ini
[Unit]
Description=Test API Application
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/test-api
# 设置微信环境变量（必须）
Environment="WECHAT_APPID=wx1234567890abcdef"
Environment="WECHAT_SECRET=abcdef1234567890abcdef1234567890ab"
ExecStart=/usr/bin/java -Xms512m -Xmx1024m -XX:+UseG1GC -jar /root/test-api/test-api-0.0.1-SNAPSHOT.jar --spring.config.location=classpath:/application.properties,file:/root/test-api/config/application-prod.properties --spring.profiles.active=prod
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**注意**：请将 `WECHAT_APPID` 和 `WECHAT_SECRET` 替换为实际的微信 AppID 和 AppSecret。

#### 7.2 使用 Systemd 命令

```bash
# 重新加载 systemd
systemctl daemon-reload

# 启动服务
systemctl start test-api

# 停止服务
systemctl stop test-api

# 重启服务
systemctl restart test-api

# 查看状态
systemctl status test-api

# 查看日志
journalctl -u test-api -f

# 设置开机自启
systemctl enable test-api
```

### 8. 防火墙配置

#### 8.1 开放端口（CentOS/RHEL）

```bash
# 使用 firewalld
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload

# 或使用 iptables
iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
service iptables save
```

#### 8.2 开放端口（Ubuntu/Debian）

```bash
# 使用 ufw
ufw allow 8080/tcp
ufw reload
```

### 9. 验证部署

#### 9.1 检查服务状态

```bash
# 查看进程
ps aux | grep test-api

# 查看端口
netstat -tlnp | grep 8080
# 或
ss -tlnp | grep 8080

# 查看日志
tail -f /opt/test-api/logs/test-api.log
```

#### 9.2 测试接口

```bash
# 测试获取用户数据接口
curl "http://localhost:8080/api/game/user-data?userId=123456"

# 或从外部访问（替换为服务器IP）
curl "http://your-server-ip:8080/api/game/user-data?userId=123456"

# 测试视频资源接口（如果已上传视频文件）
curl -I "http://localhost:8080/resources/assist/1/success.mp4"
# 应该返回 200 OK 或 404 Not Found（如果文件不存在）

# 测试视频文件是否存在
ls -lh /opt/test-api/resources/assist/1/success.mp4
# 或
ls -lh /root/test-api/resources/assist/1/success.mp4
```

---

## 三、部署检查清单

- [ ] JDK 1.8 已安装并配置
- [ ] MySQL 已安装并运行
- [ ] 数据库已创建并执行初始化脚本
- [ ] JAR 文件已上传到服务器
- [ ] 生产环境配置文件已创建并配置正确
- [ ] **资源目录已创建**：`/opt/test-api/resources/assist/` 或 `/root/test-api/resources/assist/`
- [ ] **资源目录权限已设置**：确保应用有读取权限
- [ ] **视频文件已上传**：按照 `resources/assist/{challengeId}/success.mp4` 结构放置
- [ ] 启动/停止脚本已创建并设置权限
- [ ] 防火墙端口已开放
- [ ] 服务已启动并运行正常
- [ ] 接口测试通过
- [ ] **视频接口测试通过**：访问 `http://your-server-ip:8080/resources/assist/1/success.mp4` 验证
- [ ] 日志文件正常生成

---

## 四、常见问题

### 1. 端口被占用

```bash
# 查看端口占用
lsof -i:8080
# 或
netstat -tlnp | grep 8080

# 杀死占用进程
kill -9 <PID>
```

### 2. 数据库连接失败

- 检查 MySQL 服务是否运行：`systemctl status mysql`
- 检查数据库用户名密码是否正确
- 检查数据库是否已创建
- 检查防火墙是否允许 MySQL 连接

### 3. 内存不足

调整 JVM 参数，减少内存使用：

```bash
# 修改启动脚本中的 JAVA_OPTS
JAVA_OPTS="-Xms256m -Xmx512m"
```

### 4. 日志文件权限问题

```bash
# 确保日志目录有写权限
chmod 755 /opt/test-api/logs
chown -R root:root /opt/test-api
```

### 5. 无法访问接口

- 检查服务是否运行：`systemctl status test-api`
- 检查防火墙是否开放端口
- 检查云服务器安全组是否开放端口
- 检查应用日志是否有错误

### 6. 视频资源无法访问（404）

**问题现象**：访问 `http://your-server-ip:8080/resources/assist/1/success.mp4` 返回 404

**排查步骤**：

```bash
# 1. 检查资源目录是否存在
ls -ld /opt/test-api/resources/assist
# 或
ls -ld /root/test-api/resources/assist

# 2. 检查视频文件是否存在
ls -lh /opt/test-api/resources/assist/1/success.mp4
# 或
ls -lh /root/test-api/resources/assist/1/success.mp4

# 3. 检查目录权限
ls -ld /opt/test-api/resources
# 确保应用用户有读取权限

# 4. 检查配置文件中的资源路径配置
cat /opt/test-api/config/application-prod.properties | grep resources.path
# 应该显示：app.resources.path=/opt/test-api/resources/
# 或：app.resources.path=/root/test-api/resources/

# 5. 检查路径是否正确（绝对路径 vs 相对路径）
# 生产环境建议使用绝对路径，如：/opt/test-api/resources/
# 相对路径：./resources/ 相对于 JAR 文件所在目录

# 6. 检查应用日志
tail -f /opt/test-api/logs/test-api.log | grep -i resource
```

**解决方案**：

1. **创建资源目录**：
```bash
mkdir -p /opt/test-api/resources/assist
chmod -R 755 /opt/test-api/resources
```

2. **上传视频文件**：
```bash
# 按照以下结构放置视频文件
/opt/test-api/resources/assist/1/success.mp4
/opt/test-api/resources/assist/2/success.mp4
/opt/test-api/resources/assist/3/success.mp4
```

3. **检查配置文件**：
确保 `application-prod.properties` 中配置了正确的资源路径：
```properties
app.resources.path=/opt/test-api/resources/
```

4. **重启服务**：
```bash
./restart.sh
# 或
systemctl restart test-api
```

---

## 五、生产环境优化建议

### 1. 使用 Nginx 反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 2. 配置 HTTPS

使用 Let's Encrypt 免费证书：

```bash
# 安装 certbot
yum install certbot python3-certbot-nginx
# 或
apt-get install certbot python3-certbot-nginx

# 申请证书
certbot --nginx -d your-domain.com
```

### 3. 数据库连接池优化

在 `application-prod.properties` 中添加：

```properties
# 数据库连接池配置
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
```

### 4. 日志轮转

使用 logback 或 log4j2 配置日志轮转，避免日志文件过大。

---

## 六、快速部署命令总结

```bash
# 1. 上传文件
scp target/test-api-0.0.1-SNAPSHOT.jar root@server-ip:/opt/test-api/

# 2. 创建目录和配置文件
mkdir -p /opt/test-api/{logs,config}

# 3. 创建配置文件（编辑 application-prod.properties）

# 4. 创建启动脚本（复制 start.sh, stop.sh, restart.sh）

# 5. 设置权限
chmod +x /opt/test-api/*.sh

# 6. 启动服务
/opt/test-api/start.sh

# 或使用 systemd
systemctl start test-api
```

---

完成以上步骤后，你的应用就可以在云服务器上正常运行了！

