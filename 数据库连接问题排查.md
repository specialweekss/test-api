# 数据库连接问题排查指南

## 错误信息
```
Access denied for user 'root'@'localhost'
```

## 问题原因

这个错误通常由以下原因引起：
1. **MySQL 8.0 认证方式问题（最常见）** ⚠️
   - MySQL 8.0 默认使用 `caching_sha2_password` 认证方式
   - 某些 JDBC 驱动或配置可能不支持此认证方式
   - **解决方案**：需要修改为 `mysql_native_password` 认证方式
2. **数据库密码错误**
3. **MySQL 用户权限问题**
4. **配置文件路径或内容不正确**

## ⚡ 快速解决方案（MySQL 8.0 认证问题）

**如果错误信息是 `Access denied for user 'root'@'localhost'` 且使用的是 MySQL 8.0，最可能的原因是认证方式不兼容。**

### 立即解决步骤：

```bash
# 1. 登录 MySQL（如果能登录的话）
mysql -u root -p

# 2. 检查当前认证方式
SELECT user, host, plugin FROM mysql.user WHERE user='root';

# 3. 修改为 mysql_native_password 认证方式（重要！）
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码';
FLUSH PRIVILEGES;

# 4. 验证修改是否成功
SELECT user, host, plugin FROM mysql.user WHERE user='root';
# 应该看到 plugin 列显示为 'mysql_native_password'

# 5. 退出 MySQL
EXIT;
```

**如果无法登录 MySQL，使用以下方法：**

```bash
# 1. 停止 MySQL 服务
sudo systemctl stop mysql

# 2. 以安全模式启动（跳过权限检查）
sudo mysqld_safe --skip-grant-tables --skip-networking &

# 3. 无需密码登录
mysql -u root

# 4. 修改认证方式
USE mysql;
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码';
FLUSH PRIVILEGES;
EXIT;

# 5. 停止安全模式并重启 MySQL
sudo pkill mysqld
sudo systemctl start mysql
```

**修改后重启应用：**

```bash
cd /opt/test-api
./restart.sh
```

## 解决步骤

### 步骤 1: 验证数据库连接信息

在服务器上测试数据库连接：

```bash
# 测试 MySQL 是否运行
systemctl status mysql
# 或
systemctl status mysqld

# 尝试使用 root 用户登录
mysql -u root -p
```

如果无法登录，说明密码不正确或用户不存在。

### 步骤 2: 检查配置文件

确认 `/opt/test-api/config/application-prod.properties` 文件中的数据库配置是否正确：

```bash
# 查看配置文件
cat /opt/test-api/config/application-prod.properties | grep -A 3 datasource
```

应该看到类似内容：
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
spring.datasource.username=root
spring.datasource.password=你的实际密码
```

**重要**：确保密码与 MySQL root 用户的密码一致。

### 步骤 3: 重置 MySQL root 密码（如果需要）

如果忘记 root 密码，可以重置：

#### 方法一：使用 mysql_secure_installation（推荐）

```bash
mysql_secure_installation
```

#### 方法二：手动重置密码

```bash
# 1. 停止 MySQL 服务
systemctl stop mysql
# 或
systemctl stop mysqld

# 2. 以安全模式启动 MySQL（跳过权限检查）
mysqld_safe --skip-grant-tables &

# 3. 登录 MySQL（无需密码）
mysql -u root

# 4. 在 MySQL 中执行以下命令
USE mysql;
UPDATE user SET authentication_string=PASSWORD('新密码') WHERE User='root';
FLUSH PRIVILEGES;
EXIT;

# 5. 重启 MySQL 服务
systemctl restart mysql
```

### 步骤 4: 检查 MySQL 用户权限

登录 MySQL 后，检查 root 用户的权限：

```sql
-- 登录 MySQL
mysql -u root -p

-- 查看用户权限
SELECT user, host FROM mysql.user WHERE user='root';

-- 查看 root 用户的权限
SHOW GRANTS FOR 'root'@'localhost';

-- 如果 root@localhost 不存在，创建它
CREATE USER 'root'@'localhost' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

### 步骤 5: 解决 MySQL 8.0 认证问题（重要！）

**这是 MySQL 8.0 最常见的问题！**

MySQL 8.0 默认使用 `caching_sha2_password` 认证方式，但某些 JDBC 驱动或配置可能不支持此认证方式，导致连接失败。

#### 5.1 检查当前认证方式

```sql
-- 登录 MySQL
mysql -u root -p

-- 查看用户的认证插件
SELECT user, host, plugin FROM mysql.user WHERE user='root';
```

如果 `plugin` 列显示为 `caching_sha2_password`，需要修改为 `mysql_native_password`。

#### 5.2 修改认证方式（推荐方法）

```sql
-- 修改 root@localhost 的认证方式
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码';
FLUSH PRIVILEGES;

-- 如果还有其他 root 用户（如 root@%），也需要修改
ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY '你的密码';
FLUSH PRIVILEGES;

-- 验证修改结果
SELECT user, host, plugin FROM mysql.user WHERE user='root';
```

#### 5.3 如果无法登录 MySQL（忘记密码或权限问题）

```bash
# 1. 停止 MySQL 服务
sudo systemctl stop mysql

# 2. 以安全模式启动（跳过权限检查）
sudo mysqld_safe --skip-grant-tables --skip-networking &

# 3. 无需密码登录
mysql -u root

# 4. 修改认证方式和密码
USE mysql;
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的新密码';
FLUSH PRIVILEGES;
EXIT;

# 5. 停止安全模式并重启 MySQL
sudo pkill mysqld
sudo systemctl start mysql
```

#### 5.4 为新创建的用户设置认证方式

如果创建了新的数据库用户，也要使用 `mysql_native_password`：

```sql
-- 创建用户时直接指定认证方式
CREATE USER 'testapi'@'localhost' IDENTIFIED WITH mysql_native_password BY '密码';

-- 或者修改已存在用户的认证方式
ALTER USER 'testapi'@'localhost' IDENTIFIED WITH mysql_native_password BY '密码';
FLUSH PRIVILEGES;
```

#### 5.5 验证修改是否成功

```bash
# 使用新密码登录测试
mysql -u root -p
# 输入密码，如果成功登录说明修改成功

# 在 MySQL 中再次检查
SELECT user, host, plugin FROM mysql.user WHERE user='root';
# plugin 应该显示为 'mysql_native_password'
```

### 步骤 6: 创建专用数据库用户（推荐）

为了安全，建议创建专用的数据库用户，而不是使用 root：

```sql
-- 登录 MySQL
mysql -u root -p

-- 创建专用用户
CREATE USER 'testapi'@'localhost' IDENTIFIED BY 'strong_password_here';

-- 授予权限（只授予 test 数据库的权限）
GRANT ALL PRIVILEGES ON test.* TO 'testapi'@'localhost';
FLUSH PRIVILEGES;

-- 验证权限
SHOW GRANTS FOR 'testapi'@'localhost';
```

然后修改配置文件 `/opt/test-api/config/application-prod.properties`：

```properties
spring.datasource.username=testapi
spring.datasource.password=strong_password_here
```

### 步骤 7: 验证数据库和表是否存在

```sql
-- 登录 MySQL
mysql -u root -p

-- 检查数据库是否存在
SHOW DATABASES LIKE 'test';

-- 如果不存在，创建数据库
CREATE DATABASE test DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE test;

-- 检查表是否存在
SHOW TABLES;

-- 如果表不存在，执行初始化脚本
SOURCE /path/to/init.sql;
```

### 步骤 8: 测试数据库连接

在服务器上测试数据库连接：

```bash
# 使用配置文件中的用户名和密码测试
mysql -u root -p -h localhost test
# 输入密码后，如果成功登录，说明连接正常
```

### 步骤 9: 检查应用配置文件路径

确认启动脚本中指定的配置文件路径正确：

```bash
# 查看启动脚本
cat /opt/test-api/start.sh | grep spring.config.location

# 应该看到类似：
# --spring.config.location=classpath:/application.properties,file:./config/application-prod.properties
```

确保 `/opt/test-api/config/application-prod.properties` 文件存在且内容正确。

### 步骤 10: 重启应用

修改配置后，重启应用：

```bash
cd /opt/test-api
./stop.sh
./start.sh

# 查看日志确认连接成功
tail -f logs/test-api.log
```

## 常见问题

### Q1: 配置文件修改后仍然报错

**A**: 确保：
1. 配置文件路径正确
2. 应用已重启
3. 配置文件格式正确（没有多余的空格或特殊字符）

### Q2: MySQL 8.0 连接失败（最常见问题）

**A**: MySQL 8.0 默认使用 `caching_sha2_password` 认证方式，必须修改为 `mysql_native_password`：

```sql
-- 这是必须执行的步骤！
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码';
FLUSH PRIVILEGES;
```

**其他可选方法**（如果上述方法不行）：
1. 在连接 URL 中添加 `&allowPublicKeyRetrieval=true`
2. 确保 MySQL 驱动版本 >= 8.0.11
3. 检查 MySQL 版本：`mysql --version`

### Q3: 权限被拒绝但密码正确

**A**: 检查：
1. 用户是否存在：`SELECT user, host FROM mysql.user;`
2. 用户是否有 localhost 权限
3. MySQL 是否允许本地连接

### Q4: 连接超时

**A**: 检查：
1. MySQL 服务是否运行：`systemctl status mysql`
2. 防火墙是否阻止连接
3. MySQL 是否监听 localhost：`netstat -tlnp | grep 3306`

## 快速检查清单

- [ ] **MySQL 8.0 认证方式已修改为 `mysql_native_password`（最重要！）**
- [ ] MySQL 服务正在运行
- [ ] root 用户密码正确
- [ ] 配置文件路径正确：`/opt/test-api/config/application-prod.properties`
- [ ] 配置文件中的密码与实际密码一致
- [ ] test 数据库已创建
- [ ] user_game_data 表已创建
- [ ] root 用户有 localhost 连接权限
- [ ] 应用已重启并加载新配置

## 推荐的配置文件内容

```properties
# 数据库配置
# 注意：使用 MySQL 8.0 时，必须先修改用户认证方式为 mysql_native_password
spring.datasource.url=jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=你的实际密码
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# 连接池配置（可选，提高稳定性）
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
```

## ⚠️ MySQL 8.0 重要提示

**如果使用 MySQL 8.0，必须先执行以下 SQL 命令修改认证方式：**

```sql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码';
FLUSH PRIVILEGES;
```

**这是解决 MySQL 8.0 连接问题的关键步骤！**

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：
1. MySQL 版本：`mysql --version`
2. 错误日志完整内容
3. 配置文件内容（隐藏密码）
4. MySQL 用户列表：`SELECT user, host FROM mysql.user;`

