# 微信配置说明

## 配置方式

项目已配置为**使用环境变量**来设置微信 AppID 和 AppSecret，这是更安全的方式，避免敏感信息泄露。

## 如何获取 AppID 和 AppSecret

### 步骤1：登录微信公众平台

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用管理员账号登录

### 步骤2：进入小程序/小游戏管理

- 如果是小程序：登录后选择对应的小程序
- 如果是小游戏：登录后选择对应的小游戏

### 步骤3：获取 AppID 和 AppSecret

1. 进入 **开发** → **开发管理** → **开发设置**
2. 在 **开发者密钥(AppSecret)** 部分：
   - **AppID(小程序ID)**：直接显示，可以直接复制
   - **AppSecret(小程序密钥)**：
     - 如果未设置，点击 **生成** 按钮生成
     - 如果已设置但忘记，点击 **重置** 按钮重置（**注意：重置后旧的 AppSecret 将失效**）

## 配置方法

### 开发环境

#### 方式1：设置环境变量（推荐）

**Linux/Mac:**
```bash
export WECHAT_APPID=wx1234567890abcdef
export WECHAT_SECRET=abcdef1234567890abcdef1234567890ab
```

**Windows CMD（临时生效）:**
```cmd
set WECHAT_APPID=wx1234567890abcdef
set WECHAT_SECRET=abcdef1234567890abcdef1234567890ab
```

**Windows PowerShell（临时生效）:**
```powershell
$env:WECHAT_APPID="wx1234567890abcdef"
$env:WECHAT_SECRET="abcdef1234567890abcdef1234567890ab"
```

**Windows 永久设置（推荐）:**
请参考 [Windows环境变量设置指南](./Windows环境变量设置指南.md) 进行设置。

设置环境变量后，启动项目：
```bash
# 使用 Maven 启动
mvn spring-boot:run

# 或打包后运行
java -jar target/test-api-0.0.1-SNAKEHOT.jar
```

#### 方式2：在配置文件中设置默认值（仅开发环境）

如果环境变量未设置，开发环境会使用配置文件中的默认值（`application.properties`）：

```properties
wechat.appid=${WECHAT_APPID:your_appid_here}
wechat.secret=${WECHAT_SECRET:your_secret_here}
```

**注意**：这种方式仅用于开发环境，生产环境必须使用环境变量。

### 生产环境

**生产环境必须通过环境变量设置**，配置文件不提供默认值，确保安全性。

#### Linux/Mac 服务器

**方式1：临时设置（当前会话有效）**
```bash
export WECHAT_APPID=wx1234567890abcdef
export WECHAT_SECRET=abcdef1234567890abcdef1234567890ab
java -jar test-api-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

**方式2：永久设置（推荐）**

编辑 `~/.bashrc` 或 `~/.bash_profile`：
```bash
export WECHAT_APPID=wx1234567890abcdef
export WECHAT_SECRET=abcdef1234567890abcdef1234567890ab
```

然后执行：
```bash
source ~/.bashrc
```

**方式3：使用启动脚本**

创建启动脚本 `start.sh`：
```bash
#!/bin/bash
export WECHAT_APPID=wx1234567890abcdef
export WECHAT_SECRET=abcdef1234567890abcdef1234567890ab
java -jar test-api-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

给脚本添加执行权限：
```bash
chmod +x start.sh
```

运行脚本：
```bash
./start.sh
```

**方式4：使用 systemd 服务（推荐用于生产环境）**

创建服务文件 `/etc/systemd/system/test-api.service`：
```ini
[Unit]
Description=Test API Service
After=network.target

[Service]
Type=simple
User=root
Environment="WECHAT_APPID=wx1234567890abcdef"
Environment="WECHAT_SECRET=abcdef1234567890abcdef1234567890ab"
WorkingDirectory=/opt/test-api
ExecStart=/usr/bin/java -jar /opt/test-api/test-api-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl start test-api
sudo systemctl enable test-api  # 设置开机自启
```

#### Windows 服务器

**方式1：在系统环境变量中设置**

1. 右键"此电脑" → "属性" → "高级系统设置"
2. 点击"环境变量"
3. 在"系统变量"中添加：
   - 变量名：`WECHAT_APPID`，变量值：`wx1234567890abcdef`
   - 变量名：`WECHAT_SECRET`，变量值：`abcdef1234567890abcdef1234567890ab`
4. 重启应用

**方式2：使用启动脚本**

创建 `start.bat`：
```batch
@echo off
set WECHAT_APPID=wx1234567890abcdef
set WECHAT_SECRET=abcdef1234567890abcdef1234567890ab
java -jar test-api-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

## 配置验证

### 检查环境变量是否设置成功

**Linux/Mac:**
```bash
echo $WECHAT_APPID
echo $WECHAT_SECRET
```

**Windows CMD:**
```cmd
echo %WECHAT_APPID%
echo %WECHAT_SECRET%
```

**Windows PowerShell:**
```powershell
$env:WECHAT_APPID
$env:WECHAT_SECRET
```

### 启动验证

配置完成后，启动项目：

1. **项目可以正常启动** - 说明环境变量读取成功
2. **调用 `/api/game/wx-login` 接口** - 如果配置正确，可以成功调用微信 API
3. **查看日志** - 如果配置错误，会在日志中看到相关错误信息

### 常见错误

**错误1：`Could not resolve placeholder 'WECHAT_APPID'`**

- **原因**：生产环境未设置环境变量
- **解决**：设置 `WECHAT_APPID` 和 `WECHAT_SECRET` 环境变量

**错误2：微信 API 返回 `40013: invalid appid`**

- **原因**：AppID 配置错误
- **解决**：检查环境变量中的 AppID 是否正确

**错误3：微信 API 返回 `40125: invalid appsecret`**

- **原因**：AppSecret 配置错误
- **解决**：检查环境变量中的 AppSecret 是否正确

## 安全建议

### ✅ 推荐做法

1. **使用环境变量**：不在配置文件中硬编码敏感信息
2. **限制环境变量访问权限**：确保只有应用运行用户可以读取
3. **使用配置中心**：生产环境可以使用 Apollo、Nacos 等配置中心
4. **定期轮换密钥**：定期更换 AppSecret

### ❌ 避免做法

1. **不要将 AppSecret 提交到 Git 仓库**
2. **不要在配置文件中硬编码 AppSecret**
3. **不要将环境变量写入启动脚本并提交到仓库**

## 常见问题

### Q1: AppSecret 重置后怎么办？

A: 如果 AppSecret 被重置：
1. 获取新的 AppSecret
2. 更新环境变量 `WECHAT_SECRET` 的值
3. 重启应用

### Q2: 开发环境和生产环境可以使用不同的 AppID 吗？

A: 可以。只需要在不同环境设置不同的环境变量值即可。

### Q3: 环境变量设置后需要重启应用吗？

A: 是的，修改环境变量后需要重启应用才能生效。

### Q4: 如何在不重启的情况下更新配置？

A: 如果使用配置中心（如 Apollo、Nacos），可以实现动态更新。如果使用环境变量，需要重启应用。

## 相关文档

- [微信小程序登录文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [微信小游戏登录文档](https://developers.weixin.qq.com/minigame/dev/guide/open-ability/login.html)
- [Spring Boot 外部化配置文档](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config)
